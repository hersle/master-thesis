\documentclass[a4paper,11pt,twoside]{report}

\overfullrule=5pt % draw overfull hboxes for visual inspection

\usepackage[
	%showframe, % show frame for page margins etc.
	scale=0.75, % fraction of page width/height to use
	headheight=30pt,
	%marginpar=2cm, % define to avoid \marginpar{} from overflowing
]{geometry}
\newcommand\TODO[1]{\textcolor{red}{(\textbf{TODO:} #1)}}
\newcommand\TODOM[1]{\marginpar{\TODO{#1}}}

\usepackage{ifdraft}
%\usepackage[utf8]{inputenc} % ignored with lualatex / xelatex (which are utf8-based)
\usepackage{amsmath}
\usepackage{dsfont} % for identity operator \mathds{1}
\usepackage{mathtools}
\usepackage{tensor}
\usepackage{braket}
\usepackage[retain-unity-mantissa = false]{siunitx}
\usepackage{slashed}
\usepackage[parfill]{parskip} % new paragraph: new line, no indent
%\usepackage[title]{appendix}
\usepackage[hidelinks]{hyperref} % hide colored boxes around links
\usepackage[noabbrev]{cleveref}
\usepackage{mdframed} % TODO: remove, only to draw frames for marking relevant sections to supervisor

\usepackage[labelfont=bf]{caption} % figure title in bold
\usepackage[labelfont=bf]{subcaption} % figure title in bold
%\captionsetup{subrefformat=parens}
\DeclareCaptionLabelFormat{bold}{\textbf{(#2)}}
\captionsetup{subrefformat=bold}

\usepackage{graphicx}
\usepackage[usetransparent=false,inkscapepath=.cachesvginkscape/]{svg}

%\usepackage{unicode-math} % make code display utf8 characters properly (seems that only fontspec below is enough?)
%\setmonofont{DejaVu Sans Mono} % will affect whole document, including URLs etc.
\usepackage{fontspec}
\newfontfamily\codefont{DejaVu Sans Mono}[NFSSFamily=CodeFamily] % set mono font for minted code only
\ifdraft{
	\usepackage{fancyvrb} % fast, but ugly
	\fvset{fontfamily=CodeFamily}
	\fvset{fontsize=\scriptsize}
	\fvset{frame=single}
	\newcommand{\codefile}[2]{\VerbatimInput{#2}}
}{
	\usepackage[cachedir=.cacheminted/]{minted} % nice, but slow
	%\setminted{breaklines}
	\setminted{frame=single}
	\setminted{breakanywhere}
	\setminted{fontfamily=CodeFamily}
	\setminted{fontsize=\scriptsize}
	\newcommand{\codefile}[2]{\inputminted{#1}{#2}}
}

\usepackage{fancyhdr}
\pagestyle{fancy}
\fancyhf{}
\fancyhead[LE,RO]{\textbf{\thepage}}
\fancyhead[RE]{\leftmark}
\fancyhead[LO]{\rightmark}
\fancyfoot[CE,CO]{}

\usepackage{tikz}
\usetikzlibrary{external}

% OLD. I did this before. But did not play well after adding -output-directory option.
% \tikzexternalize[prefix=.cachetikz/] % DO NOT USE DIRECTORY NAME WITH _ (. seems ok after changing .latexmkrc)

% NEW. Dirty fix for using -output-directory option. From https://tex.stackexchange.com/a/338560
\tikzexternalize
\tikzset{%
external/system call={xelatex \tikzexternalcheckshellescape --halt-on-error --interaction=batchmode --output-directory=./.cachelatex --jobname "\image" "\texsource"},
	/pgf/images/include external/.code={%
		\includegraphics{.cachelatex/#1}%
	},
}

\usepackage{pgfplots}
\usepackage{pgfplotstable}
% NOTE: externalization does NOT recompile when only the global options below are changed
\pgfplotsset{
	compat=1.17,
	% Using title={\subcaption{...}} REQUIRES text width to be set, otherwise it throws hard-to-understand errors
	% TODO: the contents of title={...} MUST change for the externalization library to recompile the figure
	every axis title/.style={at={(0.5,1)}, align=center, above=1ex, text width=0.8*\pgfkeysvalueof{/pgfplots/width}]},
}
\usepgfplotslibrary{groupplots}

\pgfplotsset{
	/pgfplots/colormap={parametrize}{rgb255=(255,255,0) rgb255=(255,0,0)}
}
\pgfplotsset{
	/pgfplots/colormap={blackred}{rgb255=(0,0,0) rgb255=(255,0,0)}
}
\pgfplotsset{
	/pgfplots/colormap={negpos}{rgb255=(0,0,255) rgb255=(0,0,0) rgb255=(255,0,0)}
}
\pgfplotsset{
	/pgfplots/colormap={stability}{rgb255=(0,255,0) rgb255=(255,0,0) rgb255=(128,0,0) rgb255=(0,0,0)}
}
\pgfplotsset{
	/pgfplots/colormap={plasma}{%
		rgb=(0.050383, 0.029803, 0.527975)
		rgb=(0.186213, 0.018803, 0.587228)
		rgb=(0.287076, 0.010855, 0.627295)
		rgb=(0.381047, 0.001814, 0.653068)
		rgb=(0.471457, 0.005678, 0.659897)
		rgb=(0.557243, 0.047331, 0.643443)
		rgb=(0.636008, 0.112092, 0.605205)
		rgb=(0.706178, 0.178437, 0.553657)
		rgb=(0.768090, 0.244817, 0.498465)
		rgb=(0.823132, 0.311261, 0.444806)
		rgb=(0.872303, 0.378774, 0.393355)
		rgb=(0.915471, 0.448807, 0.342890)
		rgb=(0.951344, 0.522850, 0.292275)
		rgb=(0.977856, 0.602051, 0.241387)
		rgb=(0.992541, 0.687030, 0.192170)
		rgb=(0.992505, 0.777967, 0.152855)
		rgb=(0.974443, 0.874622, 0.144061)
		%rgb=(0.940015, 0.975158, 0.131326) % hard to see yellow on white
	},
}
\pgfplotsset{
    /pgfplots/colormap={viridisrev}{
        indices of colormap={
            \pgfplotscolormaplastindexof{viridis},...,0 of viridis}
    },
    /pgfplots/colormap={plasmarev}{
        indices of colormap={
            \pgfplotscolormaplastindexof{plasma},...,0 of plasma}
    },
}

\newcommand{\tablemaximum}[5]{
	\pgfplotstableread{#1}{\mytable}
	\pgfplotstablesort[sort key=#2, sort cmp=float >]{\mytablesorted}{\mytable}
	\pgfplotstablegetelem{0}{#2}\of\mytablesorted
	\pgfmathsetmacro{#3}{\pgfplotsretval} % find the maximum
	\pgfplotstablegetelem{0}{#4}\of\mytablesorted
	\pgfmathsetmacro{#5}{\pgfplotsretval} % find an associated value
}

%\fancypagestyle{plain}{\pagestyle{fancy}} % make chapter front pages, bibliography etc. use same style as other pages (see https://tex.stackexchange.com/a/10046)

% make consistent style also on chapter first pages, bibliography etc.
\fancypagestyle{plain}{
	\fancyhf{}
	\fancyhead[LE,RO]{\textbf{\thepage}}
}

% urldate=long and dateabbrev=false for full date, language=british for getting 17th September 2001 format (in biblatex, without affecting rest of document)
\usepackage[style=alphabetic,giveninits=true,maxnames=10,block=ragged,date=iso,urldate=iso,seconds=true,language=british]{biblatex} 
\DeclareFieldFormat{pages}{%
	page \mkfirstpage{#1}% print first page only
}
\AtEveryBibitem{
	\clearfield{series}
	\clearlist{location}
	\clearfield{pagetotal} % useless to se total number of pages
}
\DeclareFieldFormat*{edition}{\mkbibparens{\mkbibordedition{#1} edition}}
\DeclareFieldFormat*{title}{\emph{#1}} % always italic (not the case for article titles by default)
\DeclareFieldFormat*{journaltitle}{#1} % no italics (in contrast to default)
\DeclareFieldFormat*{volume}{volume #1}
\newbibmacro*{journal+date}{
	\printtext{Published in}%
	\setunit*{\addspace}
	\mkbibbold{\printfield{year}}%
	\setunit*{\addspace}
	\printtext{by}%
	\setunit*{\addspace}
	\printfield{journaltitle}%
	\setunit*{\addcomma\space}
	\printfield{volume}%
	\setunit*{\addcomma\space}
	\printfield{pages}
}
\DeclareBibliographyDriver{article}{%
	\usebibmacro{begentry}%
	\usebibmacro{author+title+edition}%
	\newunit\newblock
	\usebibmacro{journal+date}%
	\newunit\newblock
	\usebibmacro{isbn+doi+url}%
	\usebibmacro{begentry}%
}
\renewbibmacro*{publisher+location+date}{%
	\printtext{Published in}%
	\setunit*{\addspace}%
	\mkbibbold{\printdate}%\printfield{year}%
	\setunit*{\addspace}%
	\printtext{by}%
	\setunit*{\addspace}%
	\printlist{publisher}%
}
\newbibmacro*{author+title+edition}{%
	\printnames{author}%
	\setunit*{\addcolon\space}%
	\printfield{title}%
	\iffieldundef{edition}{}{%
		\setunit*{\addspace}%
		\printfield{edition}%
	}%
	\newunit
}
\newbibmacro*{isbn+doi+url}{% ISBN -> DOI -> URL
	\iffieldundef{isbn}{%
		\iffieldundef{doi}{%
			\printfield{url}% do not have ISBN or DOI, so try to print URL (priority 3)
		}{%
			\printfield{doi}% do not have ISBN, but have DOI (priority 2)
		}%
	}{% 
		\printfield{isbn}% have ISBN (priority 1)
	}%
}
\DeclareBibliographyDriver{book}{%
	\usebibmacro{begentry}%
	\usebibmacro{author+title+edition}%
	\newunit\newblock
	\usebibmacro{publisher+location+date}%
	\newunit\newblock
	\usebibmacro{isbn+doi+url}%
	\usebibmacro{finentry}%
}

\DeclareFieldFormat*{urldate}{#1}
\newbibmacro*{published+viewed}{%
	\iffieldundef{year}{}{% print publication date if we have one
		\printtext{\autocap{p}ublished}%
		\setunit*{\addspace}
		\iffieldundef{day}{%
			\printtext{in}% YYYY       will follow
		}{%
			\printtext{on}% YYYY-MM-DD will follow
		}%
		\setunit*{\addspace}%
		\mkbibbold{\printdate}%\printfield{year}%
		\setunit*{\addcomma\space}% 
	}%
	\iffieldundef{urlyear}{}{% print download date if we have one
		\printtext{\autocap{d}ownloaded on}%
		\setunit*{\addspace}
		\printurldate%
	}
}
\DeclareBibliographyDriver{online}{%
	\usebibmacro{begentry}%
	\usebibmacro{author+title+edition}%
	\newunit\newblock
	\usebibmacro{published+viewed}%
	\newunit\newblock
	\printfield{url}%
	\usebibmacro{finentry}%
}

\addbibresource{project.bib}

\usepackage{derivative}
\derivset{\odv}[style-inf=\mathrm] % write normal derivatives with upright d
%\derivset{\odv}[switch-/=true]

\usepackage{bm}

\newcommand\dif{\mathop{}\!\mathrm{d}}
\newcommand{\abs}[1]{\left\lvert #1 \right\rvert}
\newcommand{\norm}[1]{\| {#1} \|} % TODO: remove?
\renewcommand{\det}[1]{\abs{#1}}
%\newcommand{\tdet}{\text{det}}
\DeclareMathOperator{\tdet}{det}
\DeclareMathOperator{\asin}{asin}
\DeclareMathOperator{\asinh}{asinh}
\DeclareMathOperator{\sgn}{sgn}
\newcommand{\integral}[4]{\int_{#3}^{#4} #1 \dif #2}
\newcommand{\variation}[1]{\delta #1}
\newcommand{\trace}[1]{\text{tr} #1}
\newcommand{\lagr}{\mathcal{L}}
\newcommand{\ham}{\mathcal{H}}
\newcommand{\numdensity}{\mathcal{N}}
\newcommand{\diag}[1]{\text{diag} \left( #1 \right)}
\newcommand{\taylor}{\simeq}
%\AtBeginDocument{\renewcommand{\vec}[1]{\mathbf{#1}}} % NB: need AtBeginDocument due to unicode-math: https://tex.stackexchange.com/a/457845
\renewcommand{\vec}[1]{{\bm{#1}}} % don't need AtBeginDocument now that I use fontspec instead of unicode-math
\newcommand{\bigo}{\mathcal{O}}
\newcommand\pathintdif{\mathcal{D}}
\newcommand{\pathint}[2]{\int \pathintdif #1 \, #2}
\newcommand{\comm}[2]{[ #1 , #2 ]}
\newcommand{\acomm}[2]{\{ #1 , #2 \}}
\newcommand{\thermalavg}[1]{ \left< #1 \right>}
\newcommand{\conj}[1]{{#1}^*}
%\newcommand{\res}{\text{Res}}
\DeclareMathOperator*{\res}{Res}
\DeclareMathOperator{\real}{Re}
\DeclareMathOperator{\imag}{Im}
\newcommand{\1}{\mathds{1}}
\newcommand{\diml}[1]{\hat{#1}} % use to denote dimensionless quantity
\newcommand{\solarmass}{M_\odot}

% useful intro to Latex thesis: https://www.overleaf.com/learn/latex/How_to_Write_a_Thesis_in_LaTeX_(Part_1):_Basic_Structure

\title{Neutron stars}
\author{Herman Sletmoen}
\date{\today}

\begin{document}

\maketitle
\tableofcontents
\input{prologue/prologue.tex}
\input{introduction/introduction.tex}
\input{chapter1/chapter1.tex}
\input{chapter2/chapter2.tex}
\input{chapter3/chapter3.tex}
\input{appendix/appendix.tex}

\printbibliography

\end{document}
